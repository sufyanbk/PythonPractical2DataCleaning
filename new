SELECT
  portfolio_key AS channel,

  COUNT(*) AS total_rows,
  COUNTIF(dse_x1000 IS NOT NULL AND prod_x1000 IS NOT NULL) AS comparable_rows,

  COUNTIF(CAST(dse_x1000 AS INT64) = CAST(prod_x1000 AS INT64)
          AND dse_x1000 IS NOT NULL AND prod_x1000 IS NOT NULL) AS int_match_count,
  ROUND(
    100 * SAFE_DIVIDE(
      COUNTIF(CAST(dse_x1000 AS INT64) = CAST(prod_x1000 AS INT64)
              AND dse_x1000 IS NOT NULL AND prod_x1000 IS NOT NULL),
      COUNTIF(dse_x1000 IS NOT NULL AND prod_x1000 IS NOT NULL)
    ), 2
  ) AS int_match_rate_pct

FROM base
GROUP BY channel
ORDER BY int_match_rate_pct DESC;
